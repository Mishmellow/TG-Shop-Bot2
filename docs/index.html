<!doctype html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram WebApp Shop</title>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram Web App JS API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <meta name="theme-color" content="var(--tg-theme-bg-color, #ffffff)">

    <style>
        /* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Telegram Theme Variables */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-separator: var(--tg-theme-separator-color, #e0e0e0);
            --tg-button: var(--tg-theme-button-color, #2481cc);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f4);
        }

        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            padding-bottom: 90px; /* –£—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –ì–ª–∞–≤–Ω–æ–π –ö–Ω–æ–ø–∫–∏ –¢–ì */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .main-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .product-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: space-between;
        }

        .product-col {
            width: calc(50% - 7.5px); /* –î–≤–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            flex-grow: 1;
            box-sizing: border-box;
        }

        @media (min-width: 600px) {
             .product-col {
                width: calc(33.333% - 10px); /* 3 –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ —à–∏—Ä–æ–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
             }
        }


        .card {
            background-color: var(--tg-secondary-bg);
            border: 1px solid var(--tg-separator);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            transition: box-shadow 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .card-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-bottom: 1px solid var(--tg-separator);
        }

        .card-body {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .card-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .card-text {
            color: var(--tg-hint);
            font-size: 0.9rem;
            margin-bottom: 15px;
            flex-grow: 1;
        }

        .btn-add {
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }

        .btn-add:active {
            filter: brightness(0.9);
        }

        /* –°—Ç–∏–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∑–∞–≥—Ä—É–∑–∫–µ/–æ—à–∏–±–∫–µ */
        .status-message {
            text-align: center;
            padding: 50px 0;
            color: var(--tg-hint);
        }
    </style>
</head>

<body>

    <div class="main">
        <div id="app-container">
            <div id="loading-message" class="status-message">
                –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π (–≤–º–µ—Å—Ç–æ alert/confirm) -->
    <div id="modal-message" class="modal-overlay hidden" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--tg-secondary-bg); color: var(--tg-text); padding: 20px; border-radius: 10px; max-width: 300px; text-align: center;">
            <h3 id="modal-title" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;"></h3>
            <p id="modal-body" style="margin-bottom: 20px;"></p>
            <button onclick="document.getElementById('modal-message').style.display='none';"
                style="background: var(--tg-button); color: var(--tg-button-text); padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">
                –û–ö
            </button>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('debug'); // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –æ—Ç–ª–∞–¥–∫–∏

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï FIREBASE (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let cartDocRef = null;
        let currentCart = {}; // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –∏–∑ Firestore

        // --- Telegram WebApp Instance ---
        const tg = window.Telegram ? window.Telegram.WebApp : null;

        // --- –î–ê–ù–ù–´–ï –ú–ï–ù–Æ (–¢–µ–ø–µ—Ä—å —Å –ø—É–±–ª–∏—á–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏-–∑–∞–≥–ª—É—à–∫–∞–º–∏ –≤–º–µ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π) ---
        const PRODUCTS = [
            { category: "–ö–∞–≤–∞", emoji: "üõçÔ∏è", items: [
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å: ./photos/cofee.webp
                { id: "latte", name: "–õ–∞—Ç—Ç–µ", price: 70, description: "–°–≤–µ–∂–µ—Å–≤–∞—Ä–µ–Ω–Ω—ã–π –∫–æ—Ñ–µ —Å –º–æ–ª–æ–∫–æ–º –∏ –ø—É—Ö–∫–æ–π –ø–µ–Ω–∫–æ–π.", img: "https://placehold.co/400x120/F0D9C1/4F3A2E?text=LATTE" },
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å: ./photos/latte.webp
                { id: "double_latte", name: "–î–≤–æ–π–Ω–æ–π –õ–∞—Ç—Ç–µ", price: 95, description: "–ö—Ä–µ–ø–∫–∏–π –¥–≤–æ–π–Ω–æ–π —ç—Å–ø—Ä–µ—Å—Å–æ.", img: "https://placehold.co/400x120/D9C8B5/4F3A2E?text=DOUBLE+LATTE" },
            ]},
            { category: "–ü—ñ—Ü—Ü–∞", emoji: "üçï", items: [
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å: ./photos/pizza.webp
                { id: "pepperoni_pizza", name: "–ü–∏—Ü—Ü–∞ –ü–µ–ø–ø–µ—Ä–æ–Ω–∏", price: 220, description: "–û—Å—Ç—Ä–∞—è –ø–µ–ø–ø–µ—Ä–æ–Ω–∏ —Å —Ç–æ–º–∞—Ç–Ω—ã–º —Å–æ—É—Å–æ–º.", img: "https://placehold.co/400x120/E86850/FFFFFF?text=PEPPERONI" },
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å: ./photos/havaipizza.webp
                { id: "hawaiian_pizza", name: "–ü–∏—Ü—Ü–∞ –ì–∞–≤–∞–π—Å–∫–∞—è", price: 250, description: "–ö—É—Ä–∏—Ü–∞, —Å–≤–µ–∂–∏–µ –∞–Ω–∞–Ω–∞—Å—ã, —Å—ã—Ä.", img: "https://placehold.co/400x120/81C784/FFFFFF?text=HAWAIIAN" },
            ]},
            { category: "–ë—É—Ä–≥–µ—Ä–∏", emoji: "üçî", items: [
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å: ./photos/burger.webp
                { id: "big_burger", name: "–ë–æ–ª—å—à–æ–π –ë—É—Ä–≥–µ—Ä", price: 150, description: "–ú—è—Å–Ω–æ–π –±—É—Ä–≥–µ—Ä —Å –¥–≤–æ–π–Ω—ã–º —Å—ã—Ä–æ–º –∏ –±–µ–∫–æ–Ω–æ–º.", img: "https://placehold.co/400x120/C19A6B/FFFFFF?text=BURGER" },
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å: ./photos/MChiken.webp
                { id: "chicken_burger", name: "–ß–∏–∫–µ–Ω –ë—É—Ä–≥–µ—Ä", price: 120, description: "–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ —Å —Å–æ—É—Å–æ–º –º–∞–π–æ–Ω–µ–∑.", img: "https://placehold.co/400x120/FFD580/FFFFFF?text=CHICKEN" },
            ]},
        ];

        // --- UTILITY –§–£–ù–ö–¶–ò–ò ---
        function showModal(title, body) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('modal-message').style.display = 'flex';
        }

        function getCartDocRef(uid) {
            // –ß–∞—Å—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: /artifacts/{appId}/users/{userId}/cart/user_cart
            return doc(db, 'artifacts', appId, 'users', uid, 'cart', 'user_cart');
        }

        // --- –†–ï–ù–î–ï–†–ò–ù–ì –ú–ï–ù–Æ ---
        function renderMenu() {
            const container = document.getElementById('app-container');
            container.innerHTML = '';

            PRODUCTS.forEach(category => {
                const section = document.createElement('section');
                section.innerHTML = `
                    <h1 class="main-title">${category.emoji}${category.category}</h1>
                    <div class="product-grid">
                        ${category.items.map(item => `
                            <div class="product-col">
                                <div class="card" data-id="${item.id}">
                                    <img src="${item.img}"
                                         class="card-img"
                                         alt="${item.name}"
                                         onerror="this.onerror=null; this.src='https://placehold.co/400x120/CCCCCC/333333?text=${item.name.toUpperCase().replace(/\s/g, '+')}'">
                                    <div class="card-body">
                                        <h5 class="card-title">${item.name}</h5>
                                        <p class="card-text">${item.description}</p>
                                        <button class="btn-add add-to-cart-btn" data-id="${item.id}" data-price="${item.price}" data-name="${item.name}">
                                            ${item.price} –≥—Ä–Ω
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(section);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const name = e.currentTarget.dataset.name;
                    const price = parseInt(e.currentTarget.dataset.price);
                    addToCart(id, name, price);
                });
            });
        }

        // --- –õ–û–ì–ò–ö–ê –ö–û–†–ó–ò–ù–´ FIREBASE ---
        async function addToCart(productId, name, price) {
            if (!userId || !cartDocRef) {
                showModal("–ü–æ–º–∏–ª–∫–∞", "–°–∏—Å—Ç–µ–º–∞ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞.");
                return;
            }

            try {
                // –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
                const newCartItems = { ...currentCart };

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞
                newCartItems[productId] = {
                    name: name,
                    price: price,
                    quantity: (newCartItems[productId]?.quantity || 0) + 1
                };

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ Firestore
                await setDoc(cartDocRef, { items: newCartItems }, { merge: false });

                // –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
                if (tg) tg.HapticFeedback.notificationOccurred('success');
                showModal("–î–æ–¥–∞–Ω–æ!", `"${name}" –¥–æ–¥–∞–Ω–æ –¥–æ –∫–æ—à–∏–∫–∞.`);

            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –≤ –∫–æ—Ä–∑–∏–Ω—É: ", e);
                if (tg) tg.HapticFeedback.notificationOccurred('error');
                showModal("–ü–æ–º–∏–ª–∫–∞", `–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä.`);
            }
        }

        // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï UI (Firestore Listener) ---
        function updateCartUI(cartItems) {
            let totalSum = 0;
            let totalQuantity = 0;
            const itemsArray = Object.values(cartItems);

            itemsArray.forEach(item => {
                totalSum += item.price * item.quantity;
                totalQuantity += item.quantity;
            });


            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ì–ª–∞–≤–Ω–æ–π –ö–Ω–æ–ø–∫–∏ Telegram
            if (tg) {
                if (totalQuantity > 0) {
                    tg.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ (${totalSum.toFixed(0)} –≥—Ä–Ω)`).show();
                    tg.MainButton.enable();
                } else {
                    tg.MainButton.hide();
                }
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –≤—ã—Å–æ—Ç—É WebApp
                tg.ready();
            }

            currentCart = cartItems; // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
            console.log('--- –ö–û–†–ó–ò–ù–ê –û–ë–ù–û–í–õ–ï–ù–ê –ò –°–û–•–†–ê–ù–ï–ù–ê (Firestore) ---');
            console.log('–û–±—â–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞:', totalSum.toFixed(0), '–≥—Ä–Ω');
        }

        function subscribeToCartUpdates() {
            onSnapshot(cartDocRef, (docSnapshot) => {
                if (docSnapshot.exists() && docSnapshot.data().items) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Firestore –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
                    updateCartUI(docSnapshot.data().items);
                } else {
                    // –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    updateCartUI({});
                }
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ –∫–æ—Ä–∑–∏–Ω—É: ", error);
                showModal("–ü–æ–º–∏–ª–∫–∞", "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∫–æ—à–∏–∫–∞.");
            });
        }

        // --- –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê–ñ–ê–¢–ò–Ø –ì–õ–ê–í–ù–û–ô –ö–ù–û–ü–ö–ò –¢–ì ---
        if (tg) {
            tg.ready();
            tg.MainButton.onClick(() => {
                const itemsArray = Object.values(currentCart).filter(item => item.quantity > 0);
                if (itemsArray.length === 0) return;

                let totalSum = 0;
                let orderText = "üéâ –ù–û–í–ò–ô –ó–ê–ö–ê–ó!\n\n";

                itemsArray.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    orderText += `${item.name} x ${item.quantity} —à—Ç. = ${itemTotal.toFixed(0)} –≥—Ä–Ω\n`;
                    totalSum += itemTotal;
                });

                orderText += `\n–ò–¢–û–ì–û: ${totalSum.toFixed(0)} –≥—Ä–Ω.`;
                const dataToSend = {
                    items: itemsArray,
                    total_sum: totalSum.toFixed(0),
                    order_message: orderText,
                    user_id: userId // –î–æ–±–∞–≤–ª—è–µ–º userId –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –±–æ—Ç–µ
                };

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ Telegram Bot
                tg.sendData(JSON.stringify(dataToSend));
            });
        }


        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE –∏ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥ –∏–ª–∏ –≤—Ö–æ–¥ –ø–æ —Ç–æ–∫–µ–Ω—É
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // –ü–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                onAuthStateChanged(auth, (user) => {
                    const loadingMessage = document.getElementById('loading-message');
                    if (user) {
                        userId = user.uid;
                        cartDocRef = getCartDocRef(userId);
                        renderMenu();
                        subscribeToCartUpdates(); // –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
                    } else {
                        loadingMessage.textContent = "–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó.";
                    }
                });

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
                document.getElementById('loading-message').textContent = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.";
            }
        }

        initializeAppAndAuth();
    </script>

</body>

</html>